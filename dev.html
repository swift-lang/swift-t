<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 10.2.0" />
<title>Swift/T Developers' Guide</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}



/* Swift/T guide customizations */

a:visited {
  color: gray;
}
h5 {
  font-size: 0.8em;
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article" style="max-width:875px">
<div id="header">
<h1>Swift/T Developers' Guide</h1>
<span id="author">Justin M. Wozniak</span><br />
<span id="revdate">March 2023</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This document is for developers interested in modifying or extending
the Swift/T codebase.</p></div>
<div class="paragraph"><p>This document assumes you know everything in the
<a href="http://swift-lang.org/Swift-T/guide.html">general user guide</a> first.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_questions">1. Questions</h2>
<div class="sectionbody">
<div class="paragraph"><p>For further support, post to the
<a href="https://groups.google.com/forum/#!forum/swift-t-user">Swift/T User Group</a>.</p></div>
<div class="paragraph"><p>Please file documentation requests here:
<a href="https://github.com/swift-lang/swift-t/issues">https://github.com/swift-lang/swift-t/issues</a></p></div>
<div class="paragraph"><p>with <code>Type:Doc</code>.</p></div>
<div class="paragraph"><p>These can be:</p></div>
<div class="ulist"><ul>
<li>
<p>
Requests for more comments in the code
</p>
</li>
<li>
<p>
Clarifications in the Swift/T Guide or enhancements to this document
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_contribute_to_swift_t">2. How to contribute to Swift/T</h2>
<div class="sectionbody">
<div class="paragraph"><p>Swift/T is an interesting project to work on if you are interested in
any of the following areas:</p></div>
<div class="ulist"><ul>
<li>
<p>
Compilers
</p>
<div class="ulist"><ul>
<li>
<p>
Language-language translators
</p>
</li>
<li>
<p>
Parser generators (ANTLR)
</p>
</li>
<li>
<p>
Data flow languages and run time technologies
</p>
</li>
</ul></div>
</li>
<li>
<p>
Languages for large-scale computer systems:
</p>
<div class="ulist"><ul>
<li>
<p>
High performance computing
</p>
</li>
<li>
<p>
Cloud computing
</p>
</li>
<li>
<p>
Distributed computing
</p>
</li>
<li>
<p>
MPI
</p>
</li>
<li>
<p>
Master-worker systems
</p>
</li>
<li>
<p>
Alternatives to MapReduce
</p>
</li>
</ul></div>
</li>
<li>
<p>
Libraries, frameworks, and abstractions
</p>
<div class="ulist"><ul>
<li>
<p>
Dataflow libraries for common tasks
</p>
</li>
<li>
<p>
Environments for rapid prototyping
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Swift/T is based on the following key technologies:</p></div>
<div class="ulist"><ul>
<li>
<p>
ANTLR for parsing, with a Java-based compiler
</p>
</li>
<li>
<p>
Tcl as a run time implementation language
</p>
</li>
<li>
<p>
MPI for communication
</p>
</li>
<li>
<p>
ADLB for master-worker task distribution
</p>
</li>
<li>
<p>
SWIG to connect user libraries to Swift
</p>
</li>
</ul></div>
<div class="paragraph"><p>Get involved!</p></div>
<div class="paragraph"><p>The list of current issues is hosted on the GitHub issue tracker:</p></div>
<div class="paragraph"><p><a href="https://github.com/swift-lang/swift-t/issues">https://github.com/swift-lang/swift-t/issues</a></p></div>
<div class="paragraph"><p>You can suggest new issues or try to address one of the current ones.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_conceptual_overview">3. Conceptual overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>The premise of Swift/T is to 1) translate a Swift script into a
runnable format for execution at very large scale, on MPI, and 2) to
enable it to call into a variety of external code (leaf functions),
including the shell, native code libraries, and external scripting
languages.  Since Swift is primarily about distributing these leaf
functions, the key component of our runtime is ADLB.  Thus, we need to
translate Swift into an ADLB program.</p></div>
<div class="paragraph"><p>We do this by first providing a convenient compiler target called
Turbine.  This provided a textual Tcl interface for our core runtime
features.  At runtime, we simply launch many Tcls across the machine
and allow them to communicate by calling into the ADLB library.  Thus,
we provide a Tcl extension for ADLB.  The rest of Turbine is just glue
code to 1) provide a more convenient compiler target and 2) provide
Swift features, such as its string library and interfaces to external
code.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_execution">4. Basic execution</h2>
<div class="sectionbody">
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Swift/T typically starts with a user invocation of <code>swift-t</code>, a
simple shell script.  This invokes <code>stc</code> and <code>turbine</code>, which are also
shell scripts.  All use <code>getopt</code>.
</p>
</li>
<li>
<p>
<code>stc</code> translates the <code>getopt</code>&ZeroWidthSpace;s to Java properties,
to be passed into the JVM via <code>java -D</code>.
</p>
</li>
<li>
<p>
STC starts in <code>exm/stc/ui/Main.java</code>.  All properties are registered
in <code>exm/stc/common/Settings.java</code>.  STC emits a <code>&#42;.tic</code> file.
</p>
</li>
<li>
<p>
Turbine starts as a parallel invocation of <code>tclsh</code>, each running the
STC-generated <code>&#42;.tic</code> file.  The beginning of the program is thus the
first commands in the <code>&#42;.tic</code> file, <code>turbine::defaults</code> and so on.
These are defined in the Turbine <code>lib/</code> directory, which contains all
the Tcl source and the Turbine shared object, which links to ADLB.
</p>
</li>
<li>
<p>
ADLB is initiated and controlled through calls to its Tcl interface,
defined in <code>turbine/code/src/tcl/adlb</code>.
</p>
</li>
</ol></div>
<div class="sect2">
<h3 id="_stc">4.1. STC</h3>
<div class="paragraph"><p>STC ingests a Swift file and emits a Tcl file for execution by
Turbine, called Turbine Intermediate Code (TIC).  It parses the Swift
code using ANTLR file <code>exm/stc/ast/ExM.g</code>.  When STC is built by Ant,
this file is translated into Java source code (see Ant target
<code>antlr.generate</code>).</p></div>
<div class="paragraph"><p>When STC starts in <code>Main.java:main()</code>, it does three key things:
process options, preprocess the Swift code (via <code>cpp</code>), and call into
the <code>STCompiler</code> class to perform translation.  This walks the
ANTLR-generated AST in <code>exm/stc/frontend/ASTWalker</code>.</p></div>
<div class="paragraph"><p>Once translation and optimization are finished, an AST of Tcl code is
generated via the classes in <code>exm/stc/tclbackend/</code>.  This AST is then
converted to a string via recursive calls to the various <code>appendTo()</code>
methods in the <code>TclTree</code> class, then simply written to the TIC file.</p></div>
</div>
<div class="sect2">
<h3 id="_turbine">4.2. Turbine</h3>
<div class="paragraph"><p>Consider this Tcl script (<code>f.tcl</code>):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>puts "HI"</code></pre>
</div></div>
<div class="paragraph"><p>This can be run as an MPI program:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ mpiexec -n 2 f.tcl
HI
HI</code></pre>
</div></div>
<div class="paragraph"><p>Turbine simply runs the same thing:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ turbine f.tcl
HI
HI</code></pre>
</div></div>
<div class="paragraph"><p>At first glance, Turbine is simply a parallel Tcl interpreter.
However, Turbine also provides the <code>turbine</code> Tcl package, which
contains the contents of the <code>lib/</code> directory: Tcl scripts and a
shared object.  These provide all the TIC features necessary for STC.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_systems">5. Build systems</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_makefiles">5.1. Makefiles</h3>
<div class="paragraph"><p>The build system for the three Makefile-based systems (c-utils, ADLB,
Turbine) is based on the following paper "Recursive Make Considered
Harmful":</p></div>
<div class="paragraph"><p><a href="http://aegis.sourceforge.net/auug97.pdf">http://aegis.sourceforge.net/auug97.pdf</a></p></div>
<div class="paragraph"><p>The Autoconf-based configuration system primarily sets C preprocessor
variables in <code>config.h</code> via <code>AC_DEFINE()</code> and Makefile variables via
<code>AC_SUBST()</code>.</p></div>
<div class="paragraph"><p>Much of the complexity in the build system is due to attempts to run
on various exotic systems.</p></div>
<div class="paragraph"><p>C-utils and ADLB have relatively simple builds.
Turbine is the most complex- that is where everything is linked
together.</p></div>
<div class="paragraph"><p>One common error mode is a silent <code>make</code> failure due to a missing
header file.  Use <code>make check_includes</code> to detect these errors.</p></div>
<div class="paragraph"><p>Other useful Makefile features:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>make V=1</code> or <code>make V=2</code> for verbose builds
</p>
</li>
<li>
<p>
<code>make deps</code> to make the dependency files
</p>
</li>
<li>
<p>
<code>make tags</code> to make an <code>etags</code> <code>TAGS</code> file
</p>
</li>
</ul></div>
<div class="paragraph"><p>Our convention is to filter <code>*.mk.in</code> to <code>*.mk</code> via <code>configure</code>;
unfiltered makefile includes are <code>*.mkf</code>.  (This eases the use of
<code>.gitignore</code> .)</p></div>
</div>
<div class="sect2">
<h3 id="_ant">5.2. Ant</h3>
<div class="paragraph"><p>The build system for STC is a relatively simple Ant build file.  The
only complexity is running ANTLR, which generates Java source code,
before compiling all the Java source into one big JAR file.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_learn_the_code">6. How to learn the code</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_prerequisites">6.1. Prerequisites</h3>
<div class="ulist"><ul>
<li>
<p>
Strong Unix programming: C, Make, shell.  (We use ZSH for convenience and
  readability but strive to keep things close to the POSIX shell.)
</p>
</li>
<li>
<p>
Basic MPI knowledge is necessary.  Swift/T only uses a small portion
  of MPI, the basic sends and receives.  You need to be able to write
  and run toy MPI programs.
</p>
</li>
<li>
<p>
The main ADLB features are just blocking send/receive.  There are
  some nonblocking calls that are only necessary for advanced internal
  features (work stealing probes).
</p>
</li>
<li>
<p>
Moderate Tcl knowledge is necessary for Turbine.  We make pervasive
  use of Tcl extensions to C, but rarely use advanced Tcl language
  tricks.  SWIG is optional.
</p>
</li>
<li>
<p>
Moderate Java knowledge is necessary for STC.  You need to know
  ANTLR.  STC does not use any other complex Java APIs.
</p>
</li>
<li>
<p>
Concurrency: We do not use threads.  All Swift/T concurrency comes
  from ADLB/MPI and the <a href="#rule">Turbine <code>rule</code></a> statement.  This makes things
  mostly sequential and easier to debug.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_things_to_do">6.2. Things to do</h3>
<div class="ulist"><ul>
<li>
<p>
Read the <a href="http://swift-lang.org/papers">papers</a>
</p>
</li>
<li>
<p>
Read the tests, particularly the Turbine tests.  There are fewer of
  them but they demonstrate how Swift/T implements Swift semantics.
  See the STC test guide (About.txt) for further notes.
</p>
</li>
<li>
<p>
Run the <a href="http://swift-lang.org/Swift-T/leaf.html">leaf guide examples</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stc_internals">7. STC internals</h2>
<div class="sectionbody">
<div class="paragraph"><p>The most complete and up-to-date reference for the STC compiler is the
Javadocs generated from the source tree for high-level information and
the source itself for low-level information.  The Javadocs contain
descriptions of each package and each class and hopefully make it
reasonably easy to explore the source tree.  To generate them from the
STC source, run <code>ant javadoc</code> in the code directory.  However, this page
provides a general overview and introduction that may make it easier
to get into the code base.</p></div>
<div class="sect2">
<h3 id="_architecture">7.1. Architecture</h3>
<div class="paragraph"><p>The compiler is basically a pipeline which takes the Swift program
from the Swift source, into the compiler&#8217;s intermediate
representation, and then into executable Tcl code.</p></div>
<div class="paragraph"><p>We need a specialized intermediate representation in the compiler
because neither the Swift code nor the Tcl code is well-suited to
being analyzed or optimized.  Optimization is especially important for
Turbine, because our experience with a simpler compiler that
translated directly from Swift to Turbine generated very inefficient
Turbine code, which performs many unnecessary runtime operations.  We
could implement ad-hoc optimizations with this compiler organization,
but it was challenging, required a lot of ad-hoc changes to the
compiler and was not going to be maintainable in the long run.</p></div>
<div class="paragraph"><p>The intermediate representation is described in more detail further
down this page in the Swift-IR section.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>                  (analysis,
                  semantic checks)          (flatten)        (code generation)
Swift source -----&gt; AST -----&gt; AST + analysis------&gt; Swift-IR------&gt; Tcl
            (parse)                              ^             |
                                                 |             |
                                                 |             |
                                                 +-------------+
                                                   (optimise)</code></pre>
</div></div>
<div class="sect3">
<h4 id="_parsing">7.1.1. Parsing</h4>
<div class="ulist"><ul>
<li>
<p>
Input: Swift file on disk
</p>
</li>
<li>
<p>
Output: AST for Swift program
</p>
</li>
<li>
<p>
How: Using ANTLR grammar in ExM.g
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_variable_analysis">7.1.2. Variable Analysis</h4>
<div class="ulist"><ul>
<li>
<p>
Input: AST for Swift Program
</p>
</li>
<li>
<p>
Output: Information about how each variable is used in each block (i.e. whether it is read, written, etc)
</p>
</li>
<li>
<p>
Checks: Generates errors and warnings about dataflow violations (e.g. read-without-write)
</p>
</li>
<li>
<p>
How: <code>VariableUsageAnalyser.java</code>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_tree_walking">7.1.3. Tree Walking</h4>
<div class="ulist"><ul>
<li>
<p>
Input: AST, Variable Analysis Output
</p>
</li>
<li>
<p>
Output: Lots of calls to <code>STCMiddleEnd</code> to build tree
</p>
</li>
<li>
<p>
How: <code>ASTWalker.java</code>, <code>ExprWalker.java</code>, <code>Context.java</code>,
  <code>LocalContext.java</code>,
  <code>GlobalContext.java</code>, <code>TypeChecker.java</code>
</p>
</li>
<li>
<p>
Checks: type checks the whole program
</p>
</li>
<li>
<p>
Misc: some optimizations are implemented at this level, such as caching struct fields, just because it was easier to do that way
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_intermediate_representation_construction">7.1.4. Intermediate Representation Construction</h4>
<div class="ulist"><ul>
<li>
<p>
Input: sequence of calls to STCMiddleEnd which describe program
</p>
</li>
<li>
<p>
Output: IR tree for program
</p>
</li>
<li>
<p>
How: <code>STCMiddleEnd</code> builds tree.  IC constructs are defined under <code>stc.ic.tree</code>
</p>
</li>
<li>
<p>
Checks: nothing formally, but lots of assertions to make sure the previous stages aren&#8217;t misbehaving
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_optimization">7.1.5. Optimization</h4>
<div class="ulist"><ul>
<li>
<p>
Input: IR tree
</p>
</li>
<li>
<p>
Output: IR tree
</p>
</li>
<li>
<p>
How:
</p>
</li>
<li>
<p>
All optimiser passes are under <code>stc.ic.opt</code>.  Some transformations
of code tree are assisted by methods of tree classes
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_tcl_generation">7.1.6. Tcl Generation</h4>
<div class="ulist"><ul>
<li>
<p>
Input: sequence of calls to <code>TurbineGenerator</code> (generated from IR tree)
</p>
</li>
<li>
<p>
Output: Tcl code as string
</p>
</li>
<li>
<p>
How: Each construct in IR tree makes calls to <code>TurbineGenerator</code>.
  <code>TurbineGenerator.java</code>, <code>Turbine.java</code>, classes under
  <code>stc.tclbackend</code> package are used to build and output the Tcl
  output code.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_code_organization">7.2. Code organization</h3>
<div class="paragraph"><p>The best way to get an overview of the stc source code layout is to
look at the Javadocs.  To construct the Javadoc run <code>ant javadoc</code> in the
<code>stc/code</code> directory.  This will create html pages under the javadoc
directory/ This is an overview of what is in the STC Java source code.</p></div>
</div>
<div class="sect2">
<h3 id="_antlr">7.3. ANTLR</h3>
<div class="paragraph"><p>The SwiftScript parser is generated at build time by <code>build.xml</code>
target <code>antlr.generate</code> This generates the Java source in
<code>src/exm/stc/ast/antlr</code>.  At run time, this package is used by
<code>Main.runANTLR()</code> to generate the SwiftScript AST in the ANTLR Tree
object</p></div>
</div>
<div class="sect2">
<h3 id="_swiftscript_ast">7.4. SwiftScript AST</h3>
<div class="paragraph"><p>The ANTLR Tree is passed to and walked by class SwiftScript, which
progresses down the tree and makes calls to <code>TurbineGenerator</code>.</p></div>
<div class="paragraph"><p>TIC statements correspond closely to the original SwiftScript so this
is straightforward.</p></div>
</div>
<div class="sect2">
<h3 id="_tcl_generation_2">7.5. Tcl generation</h3>
<div class="paragraph"><p>We construct an in-memory tree representing the Tcl output program
(under <code>exm.stc.tclbackend.tree</code>) which is then written to the output.</p></div>
<div class="paragraph"><p>This package creates structured data in memory.  The Tcl program is
represented as a big sequence of commands.  Other Tcl syntax features
are also representable.  The package is big a class hierarchy; <code>TclTree</code>
is the most abstract class.</p></div>
<div class="paragraph"><p>STC stores the working Tcl tree in <code>TurbineGenerator.tree</code> .  When it
is fully built, the String representation is obtained via
<code>TurbineGenerator.code()</code> and is written to the output file
(cf. <code>STCompiler.compile()</code>).</p></div>
<div class="sect3">
<h4 id="_historical_note">7.5.1. Historical note</h4>
<div class="paragraph"><p>Multiple avenues were explored for generating Tcl:</p></div>
<div class="ulist"><ul>
<li>
<p>
String generation right in TurbineGenerator:
  This got messy quickly with multiple lines of string, spacing, and new
  line issues mixed in with logic.
</p>
</li>
<li>
<p>
A lightweight Tcl API to generate common string patterns:
  This was not much better.
</p>
</li>
<li>
<p>
StringTemplate: Swift/K used this approach.  The library is produced
  by the ANTLR people. My opinion is that this is a moderately complex
  technology that does not give us enough control over the output
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_settings">7.6. Settings</h3>
<div class="paragraph"><p>In general, parser settings should be processed as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
Entered into the UI through the <code>stc</code> script which converts
  command-line arguments or environment variables into Java properties
  (<code>-D</code>).
</p>
</li>
<li>
<p>
From there, general settings should go into class <code>Settings</code>
</p>
</li>
<li>
<p>
Exceptions: Logging, input SwiftScript and output Tcl locations are not in Settings.
  The target Turbine version is set at compile time by editing Settings.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_debugging_stc">7.7. Debugging STC</h3>
<div class="paragraph"><p>Tip: When debugging the compiler, it is convenient to do:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>stc -l /dev/stdout &lt;input&gt;.swift /dev/stdout</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_turbine_internals">8. Turbine internals</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_builtins">8.1. Builtins</h3>
<div class="paragraph"><p>Turbine implements the Swift/T standard library in its <code>export/</code>
directory.  Some libraries (e.g., string) are implemented in pure Tcl.
Other TIC features are implemented in C code exposed to Tcl in
<code>src/tcl</code>.  For example, <code>string.swift:sprintf()</code> refers to Tcl
function <code>sprintf</code> which is implemented in <code>lib/string.tcl</code>, which
simply uses the Tcl function <code>format</code>.  The <code>sprintf</code> function
operates on Turbine data (TDs), which are integers that are the
identifiers of data stored in ADLB.  A <a href="#rule"><code>rule</code></a> is used to trigger
data-dependent execution, described next.</p></div>
</div>
<div class="sect2">
<h3 id="_turbine_data">8.2. Turbine data</h3>
<div class="paragraph"><p>When Swift code declares, reads, or writes data, these are translated
into ADLB data operations <code>_Create()</code>, <code>_Retrieve()</code>, and <code>_Store()</code>
(see <code>adlb.h</code>).  These functions are exposed to TIC as Tcl functions
<code>adlb::create</code>, <code>adlb::retrieve</code>, and <code>adlb::store</code>.  However,
higher-level wrapper interfaces are targeted by STC, found in
<code>lib/data.tcl</code>.  These handle the various types, provide logging, and
so on.  They also support the Swift/T reference-counting-based garbage
collection scheme (<code>_incr</code> and <code>_decr</code> generally refer to this count,
when it reaches 0, the variable is garbage-collected by ADLB).</p></div>
</div>
<div class="sect2">
<h3 id="_turbine_concepts">8.3. Turbine concepts</h3>
<div class="paragraph"><p>Swift/T progress is managed by the following Turbine concepts:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
TD
</dt>
<dd>
<p>
A Turbine datum.  Represented in Tcl by a 64-bit TD number.  A TD may be
open (unset) or closed (set).  TD IDs are represented in the log as
<code>&lt;ID&gt;</code>.  The types are:
</p>
<div class="ulist"><ul>
<li>
<p>
void
</p>
</li>
<li>
<p>
integer
</p>
</li>
<li>
<p>
float
</p>
</li>
<li>
<p>
string
</p>
</li>
<li>
<p>
blob
</p>
</li>
<li>
<p>
container
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
Rules
</dt>
<dd>
<p>
The ADLB/Turbine data dependency engine makes progress by evaluating
Turbine <a href="#rule">rules</a>.
</p>
<div class="ulist"><ul>
<li>
<p>
A rule has a a input TD list, a TD/subscript list, a rule type,
  and an action, and optional arguments.
</p>
</li>
<li>
<p>
The action is a simple Tcl string that is <code>eval</code>'d by a possibly
  different Tcl process.  This allows actions to be load balanced by
  ADLB.
</p>
</li>
<li>
<p>
Rule types are:
</p>
<div class="ulist"><ul>
<li>
<p>
<code>CONTROL</code>: put the action into ADLB for evaluation elsewhere
</p>
</li>
<li>
<p>
<code>WORK</code>: put the action into ADLB for evaluation by a worker
</p>
</li>
<li>
<p>
<code>LOCAL</code>: send the task to local worker (deprecated)
</p>
</li>
</ul></div>
</li>
<li>
<p>
When rules are evaluated, they produce in-memory records called
  transforms (TRs).
</p>
</li>
<li>
<p>
When the transform is ready, it is released to the appropriate
  ADLB task queue to be retrieved by a worker.
</p>
</li>
<li>
<p>
The function body targeted by the action can contain arbitrary Tcl code,
  lookup data from the given TDs, launch external processes via Tcl
  <code>exec</code>, and store TDs, and issue more rule statements.
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="paragraph"><p></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Containers
</dt>
<dd>
<p>
Elements from which Turbine data structures are created.  May be used
to create associative arrays, structs, and other data structures.
Represented by a TD.  A TD plus a subscript results in another TD.
</p>
<div class="paragraph"><p>Container operations are represented in the log as, e.g.,
<code>&lt;4&gt;["k"]=&lt;8&gt;</code>, indicating that container TD 4 with subscript "k"
resulted in TD 8.</p></div>
</dd>
<dt class="hdlist1">
Subscribe
</dt>
<dd>
<p>
TRs are stored in the ADLB servers.  To make progress,
the TRs are activated when their input data is ready.  Thus, the
servers subscribe to data stored in ADLB and are notified when
data is ready.  (Cf. ADLB <code>engine.h</code>.)
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="rule">8.4. The Turbine rule statement</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">This is the most important concept (the only concept) in Turbine.</td>
</tr></table>
</div>
<div class="paragraph"><p>Data-dependent progress is controlled by Turbine rules.</p></div>
<div class="paragraph"><p>A Turbine rule statement contains:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rule input_list action options...</code></pre>
</div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>input_list</code>
</dt>
<dd>
<p>
A space-separated list (Tcl list) of TDs.  When these
are are closed, the action is <code>eval</code>'d.
</p>
</dd>
<dt class="hdlist1">
<code>action</code>
</dt>
<dd>
<p>
A string of Tcl code for execution once all inputs are
closed. Essentially, when all the inputs are closed, Turbine will make
the action ready for execution, based on the <code>type</code>.
</p>
</dd>
</dl></div>
<div class="sect3">
<h4 id="_options">8.4.1. Options</h4>
<div class="paragraph"><p>All options are optional</p></div>
<div class="listingblock">
<div class="content">
<pre><code>rule input_list action name "myfunction" type $turbine::WORK \
     target 4 parallelism 2</code></pre>
</div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>name</code>
</dt>
<dd>
<p>
An arbitrary string name used for debugging and logging.
Turbine will make up a default name
</p>
</dd>
<dt class="hdlist1">
<code>type</code>
</dt>
<dd>
<p>
<code>LOCAL</code>, <code>CONTROL</code>, or <code>WORK</code>.  Default is <code>CONTROL</code>
</p>
</dd>
<dt class="hdlist1">
<code>parallelism</code>
</dt>
<dd>
<p>
Number of processes to use for an MPI parallel task.  Default is 1.
</p>
</dd>
<dt class="hdlist1">
<code>target</code>
</dt>
<dd>
<p>
Send action to this MPI rank.  Default is any available process based on <code>type</code> (<code>$adlb::RANK_ANY</code>)
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_semantics">8.4.2. Semantics</h4>
<div class="paragraph"><p>The rule statement semantics are as follows, with respect to the Tcl
thread of execution.</p></div>
<div class="ulist"><ul>
<li>
<p>
I can pause here
</p>
</li>
<li>
<p>
I have an action I would like to perform at some point in the future
</p>
</li>
<li>
<p>
I can restart myself given the action string
</p>
</li>
<li>
<p>
Do not restart me until the given inputs are closed
</p>
</li>
<li>
<p>
When my action completes, my outputs will be closed
</p>
</li>
<li>
<p>
For <code>CONTROL</code> or <code>WORK</code>, you can execute my action on a different node
(I will be able to find my data (and call stack) in the global store)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_naming">8.4.3. Naming</h4>
<div class="paragraph"><p>The name "rule" was chosen because this is somewhat like a Makefile
rule, and the analogy was intended to be helpful.</p></div>
</div>
<div class="sect3">
<h4 id="_rationale">8.4.4. Rationale</h4>
<div class="paragraph"><p>A Turbine rule is not just a control structure, it is data- it has an
identifier and debug token, is stored in data structures, is loggable,
debuggable, etc.  The arbitrary action string provides a lot of
flexibility in how the statement may be used (by the code generator)</p></div>
</div>
<div class="sect3">
<h4 id="_further_reading">8.4.5. Further reading</h4>
<div class="paragraph"><p><a href="http://www.mcs.anl.gov/~wozniak/papers/Turbine_2013.pdf">Turbine: A
distributed-memory dataflow engine for high performance many-task
applications</a>
Wozniak, Armstrong, et al. Fundamenta Informaticae 28(3), 2013.]</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_code_layout">8.5. Code layout</h3>
<div class="sect3">
<h4 id="_tcl_packaging">8.5.1. Tcl packaging</h4>
<div class="paragraph"><p>Turbine consists of two key C libraries, ADLB and Turbine, packaged as
Tcl extensions, and several Tcl script libraries.  All of this is
packaged with Tcl conventions in <code>lib</code>.  Cf. <code>lib/make-package.tcl</code>
and <code>lib/module.mk.in</code>.</p></div>
<div class="paragraph"><p>To bring these extensions and libraries into a Tcl script, we use:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>package require turbine 0.1</code></pre>
</div></div>
<div class="paragraph"><p>This command refers to environment variable <code>TCLLIBPATH</code>, which we
set in <code>bin/turbine</code>.</p></div>
<div class="paragraph"><p>Other C features are exposed to the Tcl layer as described below.</p></div>
</div>
<div class="sect3">
<h4 id="_mpi_process_modes">8.5.2. MPI process modes</h4>
<div class="paragraph"><p>A Turbine program is a TCL script launched as an SPMD program by
<code>mpiexec</code>.  In general, the idea is to do</p></div>
<div class="listingblock">
<div class="content">
<pre><code>mpiexec -l -n ${N} tclsh something.tcl</code></pre>
</div></div>
<div class="paragraph"><p>In our case, we provide a helper script.  So in the test cases, we run</p></div>
<div class="listingblock">
<div class="content">
<pre><code>bin/turbine -l -n ${N} test/something.tcl</code></pre>
</div></div>
<div class="paragraph"><p>The Turbine MPI environment is set by the <code>mpiexec -n</code> number and the
inputs to <code>turbine::init</code>.  As a result, each MPI process will become
a Turbine Worker or ADLB Server.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Turbine Worker
</dt>
<dd>
<p>
Runs on the lowest MPI ranks.  Rank 0 calls the user <code>rules</code>
procedure, starting the program.  Work from this procedure may be
distributed to other workers.
</p>
</dd>
<dt class="hdlist1">
ADLB Server
</dt>
<dd>
<p>
Performs ADLB services, including task queues, data storage, and
data-dependent task release.  Enters <code>ADLB_Server()</code> and does not exit
until the run is complete.
Cf. <code>src/tcl/adlb/tcl-adlb.c::ADLB_Server_Cmd()</code>.  Runs on the highest
MPI ranks.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In Tcl, the mode is stored in <code>turbine::mode</code> and is either
<code>WORKER</code> or <code>SERVER</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_software_structure">8.6. Software structure</h3>
<div class="paragraph"><p>The Turbine API is a Tcl API.  Some of the features are defined in
Tcl, some are hand-coded Tcl extensions, and some are SWIG-generated
Tcl extensions.</p></div>
<div class="ulist"><ul>
<li>
<p>
The Swift/T standard library functions are defined in <code>export/*.swift</code>
</p>
</li>
<li>
<p>
All Tcl source is in <code>lib</code>
</p>
<div class="ulist"><ul>
<li>
<p>
Turbine core functionality is in:
</p>
<div class="ulist"><ul>
<li>
<p>
<code>turbine.tcl</code>: Initialization and rank management, error
    utilities, etc.
</p>
</li>
<li>
<p>
<code>container.tcl</code>: Array operation implementations
</p>
</li>
<li>
<p>
<code>worker.tcl</code>: Worker functionality
</p>
</li>
</ul></div>
</li>
<li>
<p>
All other Tcl files support the Swift/T standard library and
   correspond to the Swift/T functions defined in <code>export/*.swift</code>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Turbine C code, e.g. for caches and the worker loop is in <code>src/turbine</code>
</p>
</li>
<li>
<p>
Tcl extensions are in <code>src/tcl</code>
</p>
<div class="ulist"><ul>
<li>
<p>
<code>src/tcl/turbine</code> wraps up Turbine C code for Tcl
</p>
</li>
<li>
<p>
<code>src/tcl/adlb</code> is the Tcl extension for the ADLB code in the ADLB
   package. This includes the ADLB data calls
</p>
</li>
<li>
<p>
<code>src/tcl/blob</code> is a SWIG-generated module for advanced blob
   functionality
</p>
</li>
<li>
<p>
<code>src/tcl/mpe</code> is the MPE library for Turbine
</p>
</li>
<li>
<p>
<code>src/tcl/LANG</code> are libraries for Python, R, Julia.  These are
   optional (enabled at configure time).
</p>
</li>
<li>
<p>
<code>src/tcl/blob</code> allows for the use of <code>blob</code>&#8203;s, i.e., unformatted
   bytes.  See the <a href="blob.html">blob guide</a>.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_external_scripting_interpreters">8.6.1. External scripting interpreters</h4>
<div class="paragraph"><p>The external scripting interpreters are called through their C APIs in
each <code>tcl-LANG.c</code> .  Each receives strings of code from the Tcl
level and passes it to the interpreter for evaluation.  The result is
then packaged as a string and returned to the Tcl level.</p></div>
</div>
<div class="sect3">
<h4 id="_swift_t_code_app_code_functions">8.6.2. Swift/T <code>app</code> functions</h4>
<div class="paragraph"><p>These are handled in <code>lib/app.tcl</code> .  We call <code>execvp()</code> in
<code>tcl-turbine.c</code> to launch the program instead of Tcl&#8217;s <code>exec</code> due to
issues with <code>exec</code> experienced on Cray systems.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_features">8.7. Features</h3>
<div class="paragraph"><p>This describes the symbols available to the Turbine programmer.  These
features are required when writing STC or constructing Swift/T
extensions.</p></div>
<div class="sect3">
<h4 id="_turbine_core">8.7.1. Turbine core</h4>
<div class="paragraph"><p>The core Turbine features are as follows.</p></div>
<div class="sect4">
<h5 id="_program_structure">Program structure</h5>
<div class="paragraph"><p>Turbine code is Tcl code.  For example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&gt; cat hello.tcl
puts HELLO
&gt; turbine -n 3 hello.tcl
HELLO
HELLO
HELLO</code></pre>
</div></div>
<div class="paragraph"><p>The following code is found in nearly every Turbine program:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>package require turbine 0.1
turbine::defaults
turbine::init $servers
turbine::start rules
turbine::finalize</code></pre>
</div></div>
<div class="paragraph"><p>It loads the Turbine Tcl package, loads defaults and environment
settings, initializes Turbine, starts progress, and finalizes.</p></div>
<div class="paragraph"><p>The <code>proc rules</code> contains the initial calls to get the program
running. It is only executed by the worker with rank 0.</p></div>
<div class="paragraph"><p>Other code may be placed in functions.</p></div>
</div>
<div class="sect4">
<h5 id="_startup_shutdown">Startup/shutdown</h5>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>defaults</code>
</dt>
<dd>
<p>
Sets variable servers in the caller&#8217;s scope
<code>ADLB_SERVERS</code> is stored in servers, defaults to 1
</p>
</dd>
<dt class="hdlist1">
<code>init servers</code>
</dt>
<dd>
<p>
Initialize Turbine
Initializes ADLB
</p>
</dd>
<dt class="hdlist1">
<code>finalize</code>
</dt>
<dd>
<p>
Shuts down and reports unused rules
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect3">
<h4 id="_adlb_layer">8.7.2. ADLB layer</h4>
<div class="paragraph"><p>Turbine uses ADLB to distribute tasks and locate data.</p></div>
<div class="paragraph"><p>All Turbine variables are stored in a customized data store built into
ADLB.  This required the construction of additional ADLB API calls.</p></div>
<div class="paragraph"><p>The following ADLB features are available to Turbine.  Usually, they
are used internally by the Turbine features, they are not called
directly by the user script.</p></div>
<div class="paragraph"><p><strong>tcl-adlb.c</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>adlb::SUCCESS</code>
</dt>
<dd>
<p>
Variable represents <code>ADLB_SUCCESS</code>.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::ANY</code>
</dt>
<dd>
<p>
Variable represents "any", which is -1 in ADLB.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::init servers types</code>
</dt>
<dd>
<p>
Start ADLB with the given number of servers and work types.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::finalize</code>
</dt>
<dd>
<p>
Stop ADLB.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::put reserve_rank work type work_unit</code>
</dt>
<dd>
<p>
Submit a work unit as a string of given integer type.  Sent to given
rank, which may be <code>adlb::ANY</code>.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::get req_type answer_rank</code>
</dt>
<dd>
<p>
Get a work unit as a string of given integer type, which may be
<code>adlb::ANY</code>.  ADLB answer rank stored in <code>answer_rank</code>.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::create id data</code>
</dt>
<dd>
<p>
Instantiate the given data but do not close it.  Data may be:
</p>
<div class="ulist"><ul>
<li>
<p>
<code>string:</code>
</p>
</li>
<li>
<p>
<code>integer:</code>
</p>
</li>
<li>
<p>
<code>container:&lt;type&gt;</code>
  where <code>type</code> is the type of the container keys.
</p>
</li>
<li>
<p>
<code>file:&lt;name&gt;</code>
  where <code>name</code> is the file name.
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<code>adlb::store id data</code>
</dt>
<dd>
<p>
Store the TD.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::retrieve id</code>
</dt>
<dd>
<p>
Retrieve the TD.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::insert id subscript member</code>
</dt>
<dd>
<p>
Store TD <code>member</code> at the given <code>subscript</code> in container <code>id</code>.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::lookup id subscript</code>
</dt>
<dd>
<p>
Obtain the TD for the given <code>subscript</code> in container <code>id</code>.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::unique</code>
</dt>
<dd>
<p>
Return a unique TD.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_data_dependent_progress">8.7.3. Data-dependent progress</h4>
<div class="paragraph"><p><strong>adlb.c</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>ADLB_Dput(&#8230;)</code>
</dt>
<dd>
<p>
Called only by Turbine rule processing.  Request that the given task
execute be notified when the given TDs are closed.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_data">8.7.4. Data</h4>
<div class="sect4">
<h5 id="_data_allocation">Data allocation</h5>
<div class="paragraph"><p>Data must be allocated before it may be used as the input to a rule.</p></div>
<div class="paragraph"><p><strong>data.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>allocate [&lt;name&gt;] &lt;type&gt; &#8594; td</code>
</dt>
<dd>
<p>
Creates and returns a unique TD.  The TD is actually stored on some
ADLB server, the user does not know which one. If <code>name</code> is given,
logs a message based on <code>name</code>.
</p>
</dd>
<dt class="hdlist1">
<code>allocate_container [&lt;name&gt;] &lt;subscript type&gt; &#8594; td</code>
</dt>
<dd>
<p>
Creates and returns a unique TD that is a container with the given
subscript type: <code>"integer"</code> or <code>"string"</code>
</p>
</dd>
</dl></div>
</div>
<div class="sect4">
<h5 id="_data_storage_retrieval">Data storage/retrieval</h5>
<div class="paragraph"><p>Data storage/retrieval allows you to store Tcl values in Turbine and
retrieve Turbine TDs as Tcl values.</p></div>
<div class="paragraph"><p><strong>data.tcl</strong></p></div>
<div class="ulist"><ul>
<li>
<p>
<code>store_integer td value</code>
</p>
</li>
<li>
<p>
<code>retrieve_integer td &#8594; value</code>
</p>
</li>
<li>
<p>
<code>store_string td value</code>
</p>
</li>
<li>
<p>
<code>retrieve_string td &#8594; value</code>
</p>
</li>
<li>
<p>
<code>store_float td</code>
</p>
</li>
<li>
<p>
<code>retrieve_float td &#8594; value</code>
</p>
</li>
<li>
<p>
<code>store_void td</code>
</p>
</li>
<li>
<p>
<code>store_blob td [ list pointer length]</code>
</p>
</li>
<li>
<p>
<code>retrieve_blob td &#8594; [ list pointer length ]</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Once you have the values in Tcl, you can perform arbitrary operations
and store results back into Turbine.</p></div>
<div class="paragraph"><p>You can think of Turbine as a load/store architecture, where the
Turbine data store is main memory and the local Tcl operations
and values are the CPU and its registers.</p></div>
<div class="paragraph"><p><code>void</code> type variables may be used to represent pure dataflow- e.g.,
Swift external variables. Internally, these are just an integer.</p></div>
<div class="paragraph"><p><code>blob</code> values in Turbine/Tcl are a <code>[ list pointer length ]</code>, where
the pointer is stored as a Tcl integer and the length is the byte
length.</p></div>
<div class="ulist"><ul>
<li>
<p>
Note that to pass these pointers to SWIG interfaces you have
to cast them to <code>void*</code>, <code>double*</code>, etc.  Tools are provided by the
Turbine <code>blobutils</code> package to do this.
</p>
</li>
<li>
<p>
The pointer points to a locally allocated copy of the blob data.
This must be freed with <code>adlb::blob_free</code>.  Auto-wrapped STC functions
will automatically insert this instruction.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_literals">Literals</h5>
<div class="paragraph"><p>There is a convenience function to set up literal data.</p></div>
<div class="paragraph"><p><strong>functions.tcl</strong></p></div>
<div class="listingblock">
<div class="content">
<pre><code>set x [ literal integer 3 ]
   or
literal x integer 3</code></pre>
</div></div>
<div class="paragraph"><p>Now x is a closed TD of type integer with value 3.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_functions">8.7.5. Functions</h4>
<div class="paragraph"><p>A good way to manage progress is to define Tcl functions (procs) for
use in the execution string.</p></div>
<div class="paragraph"><p>To implement a Swift function, we often have three Tcl
functions. Consider Swift function <code>f()</code>:</p></div>
<div class="ulist"><ul>
<li>
<p>
The "rule" function: conventionally called <code>f</code>. This is called to
register the function call with the ADLB/Turbine dataflow engine
</p>
</li>
<li>
<p>
The rule statement stores the action until the inputs are ready
</p>
</li>
<li>
<p>
The "body" function: conventionally called <code>f_body</code>. This is
  called when the inputs are ready. The body function retrieves data,
  computes, and stores data
</p>
</li>
<li>
<p>
The "impl" function: conventionally called <code>f_impl</code>.  The impl acts
  on values, not addresses. This is convenient because sometimes STC
  can optimize addresses and operate on values. This saves on calls
  to the ADLB data API, which uses messaging and is expensive. Thus,
  you do not need an impl function if you just want to perform the
  computation in the body function
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code># x, y and z are string TDs. x and y may be unset
proc f { z x y } {
  rule f-$x-$y [ list $x $y ] $turbine::LOCAL "f_body no_stack $x $y $z"
}

# x, y and z are string TDs.  x and y are now set (closed)
proc f_body { x y z } {
  set s1 [ retrieve_string $x ]
  set s2 [ retrieve_string $y ]
  set s3 [ f_impl $s1 $s2 ]
  store_string $z $s3
}

# x and y are string values
proc f_impl { x y } {
  return compute_something $x $y
}

# Calling code:

allocate x string
allocate y string
allocate z string

store_string $x "sample1"
store_string $y "sample2"

f $z $x $y</code></pre>
</div></div>
<div class="paragraph"><p>The previous example could have used the literal function but it is an
opportunity to show things in full detail.</p></div>
<div class="paragraph"><p>Implementation reference: the Turbine tests and any STC-generated code.</p></div>
<div class="sect4">
<h5 id="_operators">Operators</h5>
<div class="paragraph"><p>These are the arithmetic operations available in Turbine.</p></div>
<div class="paragraph"><p>All arithmetic functions operate on TDs and are of the form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>op outputs inputs</code></pre>
</div></div>
<div class="paragraph"><p>The impl versions operate on values and are of the form:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>op_impl inputs -&gt; outputs</code></pre>
</div></div>
<div class="paragraph"><p><strong>arith.tcl</strong></p></div>
<div class="tableblock">
<table rules="all"
width="50%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top"> <strong>Integer</strong>          </th>
<th align="left" valign="top"> <strong>Float</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>plus_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>plus_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>minus_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>minus_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>multiply_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>multiply_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>divide_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>divide_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>negate_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>negate_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>mod_integer</code></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>copy_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>copy_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>max_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>max_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>min_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>min_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>floor</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>ceil</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>round</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>log_e</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>exp</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>sqrt</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>abs_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>abs_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>pow_integer</code></p></td>
<td align="left" valign="top"><p class="table"><code>pow_float</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>is_nan</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_string_manipulation">String manipulation</h5>
<div class="paragraph"><p>String functions are in <strong>string.tcl</strong>.  These make straightforward use
of the Turbine API and Tcl string capabilities.</p></div>
</div>
<div class="sect4">
<h5 id="_containers">Containers</h5>
<div class="paragraph"><p>A container is a TD that is allows one to insert and retrieve TDs
contained by it.  It is used to represent associative arrays and
structs.</p></div>
<div class="paragraph"><p>Lookups are performed on "subscripts", which are serialized, hashable
representations of the keys.  Each container has a subscript type that
represents the type of the keys: this allows for Swift loop variables
to be automatically defined. The values stored are "members" which are
strings- they typically represent TDs.  Thus, arbitrary data may be
stored in a container as an optimization</p></div>
<div class="paragraph"><p>Rules may wait on the whole container TD just like any other TD.  TDs
that are members of a container are not special. They are simply
linked into the container data structure.</p></div>
<div class="paragraph"><p><strong>tcl-adlb.c</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>allocate_container td type</code>
</dt>
<dd>
<p>
Initialize a TD as a container with the given subscript type, which
may be integer or string. The members in the container may be of any
type
</p>
</dd>
<dt class="hdlist1">
<code>container_typeof td &#8594; type</code>
</dt>
<dd>
<p>
Get the subscript type of the container as a Tcl string.
Use <code>typeof</code> to get the type of a member.
</p>
</dd>
<dt class="hdlist1">
<code>adlb::enumerate td subscripts|members|dict|count count|all offset</code>
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
<code>subscripts</code>:: Return list of subscript strings
</p>
</li>
<li>
<p>
<code>members</code>::    Return list of member TDs
</p>
</li>
<li>
<p>
<code>dict</code>::       Return Tcl dict mapping subscripts to TDs
</p>
</li>
<li>
<p>
<code>count</code>::      Return integer count of container elements
</p>
</li>
<li>
<p>
<code>count,all,offset</code>:: Return all entries or just <code>count</code>, starting
from <code>offset</code>
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<code>container_list td &#8594; list</code>
</dt>
<dd>
<p>
Obtain all subscripts in the container as a big Tcl list
(Convenience wrapper around enumerate)
</p>
</dd>
<dt class="hdlist1">
<code>container_size td &#8594; count</code>
</dt>
<dd>
<p>
(Convenience wrapper around enumerate)
</p>
</dd>
<dt class="hdlist1">
<code>container_reference c i r</code>
</dt>
<dd>
<p>
Make <code>r</code> a reference for <code>c[i]</code>. Thus, when <code>c[i]</code> is inserted, <code>r</code> is
closed by the system.  <code>r</code> is a copy of <code>c[i]</code>,
thus, <code>r</code> must be of the same type as <code>c[i]</code>.
</p>
</dd>
</dl></div>
<div class="paragraph"><p><strong>data.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>container_insert container_td subscript member</code>
</dt>
<dd>
<p>
Link member TD into the container at given subscript member is
typically a TD, allowing for linked data.
</p>
</dd>
<dt class="hdlist1">
<code>container_lookup container td subscript &#8594; member</code>
</dt>
<dd>
<p>
Lookup the member corresponding to the subscript in the given container
</p>
</dd>
</dl></div>
</div>
<div class="sect4">
<h5 id="_advanced_container_operations">Advanced container operations</h5>
<div class="paragraph"><p>These are used to support the full set of possible Swift/T array
operations.</p></div>
<div class="paragraph"><p>Currently, these contain these <code>existing name</code>, the <strong>proposed name</strong>,
and a proposed shorthand notation <strong>(PSN)</strong>.</p></div>
<div class="paragraph"><p><code>(A[i])</code> is used to express a reference on <code>A[i]</code>.</p></div>
<div class="paragraph"><p><strong>container.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>container_create_nested container subscript type</code>
</dt>
<dd>
<p>
<strong>c_v_create (CVC)</strong>
</p>
<div class="paragraph"><p>Creates subdatum when index is a value.</p></div>
<div class="paragraph"><p>Swift/T example: <code>(A[i])[j] = f();</code></p></div>
</dd>
<dt class="hdlist1">
<code>struct_create_nested struct subscript type</code>
</dt>
<dd>
<p>
<strong>struct_create (SC)</strong>
</p>
<div class="paragraph"><p>Creates subdatum in struct.</p></div>
<div class="paragraph"><p>Swift/T example: <code>s.f[i] = f();</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_container_create_nested container subscript type</code>
</dt>
<dd>
<p>
<strong>c_f_create (CFC)</strong>
</p>
<div class="paragraph"><p>Creates subdatum when index is a future.</p></div>
<div class="paragraph"><p>Swift/T example: <code>(A[i])[j] = f();</code></p></div>
</dd>
<dt class="hdlist1">
<code>container_f_insert container subscript td</code>
</dt>
<dd>
<p>
<strong>c_f_insert (CFI)</strong>
</p>
<div class="paragraph"><p>When <code>subscript</code> is set, insert <code>td</code> at <code>container[subscript]</code>.</p></div>
<div class="paragraph"><p>Swift/T example: <code>A[i] = j;</code></p></div>
</dd>
<dt class="hdlist1">
<code>container_deref_insert container subscript reference</code>
</dt>
<dd>
<p>
<strong>c_v_insert_r (CVIR)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>A[3] = (B[j]);</code></p></div>
</dd>
<dt class="hdlist1">
<code>container_f_deref_insert container subscript reference</code>
</dt>
<dd>
<p>
<strong>c_f_insert_r (CFIR)</strong>
</p>
<div class="paragraph"><p>When <code>subscript</code> and <code>reference</code> are closed, insert the TD stored in
<code>reference</code> into <code>container[subscript]</code>.</p></div>
<div class="paragraph"><p>Swift/T example: <code>A[i] = (B[j]);</code></p></div>
</dd>
<dt class="hdlist1">
<code>container_f_get_integer container subscript &#8594; td</code>
</dt>
<dd>
<p>
<strong>c_f_retrieve_integer (CFRI)</strong>
</p>
<div class="paragraph"><p>When <code>container[subscript]</code> is inserted, store a copy of that integer
result in <code>td</code>.</p></div>
<div class="paragraph"><p>Swift/T example: <code>j = A[i];</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_dereference_integer/float/string/blob reference td</code>
</dt>
<dd>
<p>
When <code>reference</code> is closed, copy its value into <code>td</code>
</p>
<div class="paragraph"><p><strong>dereference_retrieve_integer (DRI)</strong></p></div>
<div class="paragraph"><p><strong>dereference_retrieve_float (DRF)</strong></p></div>
<div class="paragraph"><p>Swift/T example: <code>j = (A[i]);</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_reference container subscript &#8594; reference</code>
</dt>
<dd>
<p>
<strong>c_f_lookup (CFL)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>f(A[i]);</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_cref_create_nested container_reference subscript type &#8594; reference</code>
</dt>
<dd>
<p>
<strong>cr_v_create (CRVC)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>A[i][3] = f();</code></p></div>
</dd>
<dt class="hdlist1">
<code>cref_create_nested container_reference subscript type &#8594; reference</code>
</dt>
<dd>
<p>
<strong>cr_f_create (CRFC)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>(A[i])[j] = f();</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_cref_lookup_literal container_reference integer td td_type</code>
</dt>
<dd>
<p>
<strong>cr_v_lookup (CRVL)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>j = (A[i])[3];</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_cref_lookup container_reference subscript td td_type</code>
</dt>
<dd>
<p>
<strong>cr_f_lookup (CRFL)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>k = (A[i])[j];</code></p></div>
</dd>
<dt class="hdlist1">
<code>cref_insert container_reference subscript td</code>
</dt>
<dd>
<p>
<strong>cr_v_insert (CRVI)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>(A[i])[3] = k;</code></p></div>
</dd>
<dt class="hdlist1">
<code>f_cref_insert container_reference subscript td</code>
</dt>
<dd>
<p>
<strong>cr_f_insert (CRFI)</strong>
</p>
<div class="paragraph"><p>Swift/T example: <code>(A[i])[j] = k;</code></p></div>
</dd>
<dt class="hdlist1">
<code>cref_deref_insert container_reference subscript td_reference outer_container</code>
</dt>
<dd>
<p>
When <code>container_reference</code> and <code>td_reference</code> are set, insert <code>td</code> at
<code>container[subscript]</code>.
</p>
<div class="paragraph"><p><strong>cr_f_insert_r (CRFIR)</strong></p></div>
<div class="paragraph"><p>Swift/T example: <code>(A[i])[j] = (B[k])</code>;</p></div>
</dd>
</dl></div>
<div class="paragraph"><p><strong>functions.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>range container start end</code>
</dt>
<dd>
<p>
Fill and close given container with integer subscripts that map to
TDs that are integers from <code>start</code> to <code>end</code>
</p>
</dd>
</dl></div>
</div>
<div class="sect4">
<h5 id="_blobs">Blobs</h5>
<div class="paragraph"><p>Blobs (Binary Large OBjects) may be used to represent byte data
(pointer+length).  This is to allow Turbine data store to store
native data from C/C++/Fortran.</p></div>
<div class="paragraph"><p>When blobs are retrieved from ADLB, they are stored in a local cache.
These entries should be freed before returning control to Turbine.</p></div>
<div class="paragraph"><p>In Tcl, the blob is a <code>[ list pointer length ]</code> where <code>pointer</code> and
<code>length</code> are integers.  <code>pointer</code> is the real pointer to the blob&#8217;s
data- it may be passed into a C function as <code>void*</code>.  <code>length</code> is the
size in bytes.</p></div>
<div class="paragraph"><p><strong>blob.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>blob_from_string</code>
</dt>
<dd>
<p>
Convert a Tcl string into a blob. String will be NULL-terminated.
</p>
</dd>
<dt class="hdlist1">
<code>string_from_blob</code>
</dt>
<dd>
<p>
Convert a blob into a string. String must be NULL-terminated
</p>
</dd>
<dt class="hdlist1">
<code>blob_from_floats</code>
</dt>
<dd>
<p>
Convert a container of floats into a blob, which is actually a C
array of doubles
</p>
</dd>
<dt class="hdlist1">
<code>floats_from_blob</code>
</dt>
<dd>
<p>
Convert a blob into a container of floats
</p>
</dd>
<dt class="hdlist1">
<code>blob_size_async</code>
</dt>
<dd>
<p>
Obtain the size of a blob in bytes
</p>
</dd>
</dl></div>
<div class="paragraph"><p><strong>tcl-adlb.c</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>retrieve_blob td → [ list pointer length ]</code>
</dt>
<dd>
<p>
Retrieve a blob from ADLB and store in the local cache.
The user must free this from cache.  Returns the pointer and length in
a Tcl list.
</p>
</dd>
<dt class="hdlist1">
<code>blob_free td</code>
</dt>
<dd>
<p>
Free the blob from the local cache.
</p>
</dd>
<dt class="hdlist1">
<code>store_blob td pointer length</code>
</dt>
<dd>
<p>
Store blob in ADLB
</p>
</dd>
</dl></div>
<div class="paragraph"><p><strong>blob.c</strong></p></div>
<div class="paragraph"><p>The following example illustrates what can go in a typical Swift/T
leaf function.  It assumes blobs <code>id1</code>, <code>id2</code> have been created.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># Retrieve input blob
set L1 [ adlb::retrieve_blob $id1 ]
set pointer1 [ lindex 0 $L1 ]
set length1 [ lindex 1 $L1 ]

# Call C function
set L2 [ user::compute $pointer1 $length1 ]

# C function returned pointer and length in L2
set pointer2 [ lindex 0 $L2 ]
set length2  [ lindex 1 $L2 ]

# Store C function result
turbine::store_blob $id2 [ list $pointer2 $length2 ]

# Free from local cache
adlb::blob_free $id1</code></pre>
</div></div>
</div>
<div class="sect4">
<h5 id="_i_o">I/O</h5>
<div class="paragraph"><p>Turbine I/O capabilities.</p></div>
<div class="paragraph"><p><strong>functions.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>trace</code>
</dt>
<dd>
<p>
Simply outputs the values of the given TDs without formatting.
</p>
</dd>
</dl></div>
<div class="paragraph"><p><strong>io.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>printf</code>
</dt>
<dd>
<p>
As <code>printf()</code> in C.  The format string is handled with the Tcl
<code>format</code> command.
</p>
</dd>
</dl></div>
<div class="paragraph"><p><strong>files.tcl</strong></p></div>
</div>
<div class="sect4">
<h5 id="_files">Files</h5>
<div class="paragraph"><p><strong>TODO: files.tcl</strong></p></div>
</div>
<div class="sect4">
<h5 id="_void">Void</h5>
<div class="paragraph"><p>Operations for <code>void</code> variables</p></div>
<div class="paragraph"><p><strong>functions.tcl</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>propagate</code>
</dt>
<dd>
<p>
Create and close a <code>void</code> TD
</p>
</dd>
<dt class="hdlist1">
<code>zero</code>
</dt>
<dd>
<p>
Convert a <code>void</code> to the integer 0.
</p>
</dd>
</dl></div>
</div>
<div class="sect4">
<h5 id="_updateables">Updateables</h5>
<div class="paragraph"><p><strong>updateable.tcl</strong></p></div>
<div class="paragraph"><p>TODO: updateables</p></div>
</div>
<div class="sect4">
<h5 id="_assertions">Assertions</h5>
<div class="paragraph"><p><strong>assert.tcl</strong></p></div>
<div class="paragraph"><p>Assertion functions are in <strong>assert.tcl</strong>.  These make straightforward
use of the Turbine API and Tcl capabilities.  When they fail, they
bring the whole Turbine execution down.</p></div>
</div>
<div class="sect4">
<h5 id="_logging">Logging</h5>
<div class="paragraph"><p><strong>tcl-turbine.c</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>log</code>
</dt>
<dd>
<p>
Simply report the given string to stdout with a timestamp.  This may
be disabled by setting environment variable <code>TURBINE_LOG=0</code>.
</p>
</dd>
</dl></div>
</div>
<div class="sect4">
<h5 id="_mpe">MPE</h5>
<div class="paragraph"><p>MPE is the primary way to obtain profiling and debugging information
from Turbine/ADLB.  CPU profiling information can also be obtained
without recompilation as described in the CPU profiling section below.
MPE log entries are automatically created by ADLB if enabled at configure
time.  One additional MPE function is available from Turbine:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>metadata</code>
</dt>
<dd>
<p>
Simply insert the given string into the log.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The MPE log will contain solo events with the "metadata" event type.</p></div>
<div class="paragraph"><p>It is safe to call this function even if MPE is not configured - it
will simply be a noop.</p></div>
</div>
<div class="sect4">
<h5 id="_system">System</h5>
<div class="paragraph"><p>System functions are in <strong>sys.tcl</strong>.  These make straightforward use of
the Turbine API and Tcl capabilities.  See the Swift/T documentation
for a sense of the purpose of these features.</p></div>
</div>
<div class="sect4">
<h5 id="_statistics">Statistics</h5>
<div class="paragraph"><p>Statistics functions are in <strong>stats.tcl</strong>.  These make straightforward
use of the Turbine API and Tcl arithmetic capabilities.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_2">8.8. Logging</h3>
<div class="paragraph"><p>Turbine has rich logging facilities.</p></div>
<div class="sect3">
<h4 id="_c_logging">8.8.1. C logging</h4>
<div class="paragraph"><p>After running <code>./configure</code> , edit <code>src/util/debug-tokens.tcl</code> to
enable debug logging for the various components.  For example, setting
<code>TCL_TURBINE ON</code> will turn on all <code>DEBUG_TCL_TURBINE()</code> macros, each
of which works like <code>printf()</code>.</p></div>
<div class="paragraph"><p>These macros are defined in <code>src/util/debug.h</code> .  Note that this file
is auto-generated at <code>make</code> time by <code>debug-auto.tcl</code> .</p></div>
</div>
<div class="sect3">
<h4 id="_tcl_logging">8.8.2. Tcl logging</h4>
<div class="paragraph"><p>Set environment variable <code>TURBINE_LOG=1</code> before running <code>turbine</code>.
This will enable all Turbine Tcl <code>log</code> statements.  The Tcl <code>log</code>
command is defined as a C function in<br />
<code>src/tcl/turbine/tcl-turbine.c:Turbine_Log_Cmd()</code> .</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adlb_x">9. ADLB/X</h2>
<div class="sectionbody">
<div class="paragraph"><p>ADLB/X is an
<a href="http://www.mcs.anl.gov/project/adlb-asynchronous-dynamic-load-balancer">ADLB</a>
implementation that additionally offers:</p></div>
<div class="ulist"><ul>
<li>
<p>
work stealing;
</p>
</li>
<li>
<p>
data storage operations;
</p>
</li>
<li>
<p>
data-dependent execution; and
</p>
</li>
<li>
<p>
parallel tasks.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Tcl bindings for ADLB/X are supported, see the ExM Swift/Turbine
project.</p></div>
<div class="paragraph"><p>ADLB/X is internally called XLB.  External C symbols are prefixed with
<code>xlb_</code>.</p></div>
<div class="sect2">
<h3 id="_user_interface">9.1. User interface</h3>
<div class="paragraph"><p>The ADLB user interface is entirely contained in <code>adlb.h</code>.  This is
only file that is installed by <code>make install</code>.  See the ADLB papers
and the example apps for use scenarios.</p></div>
</div>
<div class="sect2">
<h3 id="_workers_and_servers">9.2. Workers and servers</h3>
<div class="paragraph"><p>The number of servers is specified by the call to <code>ADLB_Init()</code>.  Each
worker is associated with one server (cf. <code>xlb_map_to_server(int
rank)</code>).  Task operations always go to that server, unless the task is
targeted to a worker associated with another server.  Data operations
go to the server on which the data resides (cf. <code>ADLB_Locate(long id)</code>).</p></div>
</div>
<div class="sect2">
<h3 id="_code_conventions">9.3. Code conventions</h3>
<div class="sect3">
<h4 id="Checks">9.3.1. Error checks</h4>
<div class="paragraph"><p>There are 3 main error code types:</p></div>
<div class="ulist"><ul>
<li>
<p>
MPI error codes (<code>int</code>);
</p>
</li>
<li>
<p>
ADLB error codes (<code>adlb_code</code>); and
</p>
</li>
<li>
<p>
ADLB data error codes (<code>adlb_data_code</code>).
</p>
</li>
</ul></div>
<div class="paragraph"><p>These are all converted to <code>adlb_code</code>.  We have a system for checking
these and propagating errors up the call stack, see <code>checks.h</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_mpi_macros">9.3.2. MPI macros</h4>
<div class="paragraph"><p>To simplify calls to MPI, we have wrapper macros that use XLB code
conventions, error handling techniques, and debug logging.  In many
cases, these turn 5-line expressions into 1-line expressions.  Macros
<code>SEND()</code>, <code>RECV()</code>, <code>IRECV()</code> correspond to <code>MPI_Send()</code>, <code>MPI_Recv()</code>,
<code>MPI_Irecv()</code>, etc.  Cf. <code>messaging.h</code>.</p></div>
</div>
<div class="sect3">
<h4 id="Debugging">9.3.3. Debugging modes</h4>
<div class="paragraph"><p>Multiple levels of logging verbosity may be enabled at configure
time.  These are primarily controlled through the macros <code>DEBUG()</code> and
<code>TRACE()</code>.</p></div>
<div class="paragraph"><p>Configure options:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>--enable-log-debug</code>
</dt>
<dd>
<p>
Enable <code>DEBUG()</code> logging (moderately verbose)
</p>
</dd>
<dt class="hdlist1">
<code>--enable-log-trace</code>
</dt>
<dd>
<p>
Enable <code>TRACE()</code> logging (very verbose)
</p>
</dd>
<dt class="hdlist1">
<code>--enable-log-trace-mpi</code>
</dt>
<dd>
<p>
Trace every MPI macro call (extremely verbose)
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_code_comments">9.3.4. Code comments</h4>
<div class="paragraph"><p><code>extern</code> functions are primarily documented in their <code>*.h</code> file.
Implementation notes may be given in the <code>*.c</code> file.  For <code>static</code>
functions, the primary documentation is at the function definition;
prototypes may be anywhere in the file.</p></div>
<div class="paragraph"><p>We use Doxygen (JavaDoc) comments (<code>/** */</code>) for things that ought to
appear in generated documentation (although we currently do not use
such systems).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_rpc_system">9.4. RPC system</h3>
<div class="paragraph"><p>ADLB is primarily a worker-server system.  The workers execute ADLB in
<code>adlb.c</code>.  These issue calls in a typical <code>IRECV(); SEND(); WAIT();</code>
pattern.  This allows the server to send the initial response
with <code>RSEND</code>.</p></div>
<div class="paragraph"><p>The server uses <code>PROBE</code> and dispatches to the appropriate handler.
The handler functions are registered with the RPC system
(cf. <code>handlers.c</code>).  Each is a mapping from an MPI tag to a function.</p></div>
</div>
<div class="sect2">
<h3 id="_work_queue">9.5. Work queue</h3>
<div class="paragraph"><p>When work submitted by <code>ADLB_Put()</code> is stored by the server, it is
stored in the work queue (workqueue.h).  The work queue data
structures store work units.  They allow fast lookups for work units
based on the task type, priority, and target.  Parallel tasks are
treated separately.</p></div>
<div class="paragraph"><p>Note that if a process that matches the work unit is in the request
queue, the work unit is not stored, it is redirected to the worker
process.  This allows for worker-worker communication.</p></div>
</div>
<div class="sect2">
<h3 id="_request_queue">9.6. Request queue</h3>
<div class="paragraph"><p>When a worker issues an <code>ADLB_Get()</code>, if work is not immediately
available, the worker rank is stored in the request queue
(<code>requestqueue.h</code>).  Requests are stored in data structures that allow
for fast lookup by rank and work unit type.</p></div>
</div>
<div class="sect2">
<h3 id="_data_operations">9.7. Data operations</h3>
<div class="paragraph"><p>Data operations all return immediately and do not face the same
complexity as the queued task operations.  The implementation of all
data operations is in <code>data.c</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_work_stealing">9.8. Work stealing</h3>
<div class="paragraph"><p>Work stealing is triggered when:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
a worker does an <code>ADLB_Get()</code> and the work queue cannot find a
match; or
</p>
</li>
<li>
<p>
the server is out of work and has not attempted a steal recently
(daemon steal).
</p>
</li>
</ol></div>
<div class="paragraph"><p>The stealing server syncs and issues the STEAL RPC on a random
server.  Half of the tasks, round up, are stolen.</p></div>
</div>
<div class="sect2">
<h3 id="Sync">9.9. Server-server sync</h3>
<div class="paragraph"><p>Server-server syncs are required to avoid a deadlock when two servers
attempt to perform RPCs on each other simultaneously.  See <code>sync.h</code>
for information about this protocol.</p></div>
</div>
<div class="sect2">
<h3 id="_parallel_tasks">9.10. Parallel tasks</h3>
<div class="paragraph"><p>TODO</p></div>
</div>
<div class="sect2">
<h3 id="_mpe_2">9.11. MPE</h3>
<div class="paragraph"><p>TODO</p></div>
</div>
<div class="sect2">
<h3 id="_batcher">9.12. Batcher</h3>
<div class="paragraph"><p><code>batcher</code> is a simple demonstration of ADLB useful for learning how it
works.  See the header of <code>batcher.c</code>.  Build it with <code>make apps/batcher.x</code></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cpu_profiling">10. CPU Profiling</h2>
<div class="sectionbody">
<div class="paragraph"><p>It is possible to obtain information about CPU usage in Turbine by using
the Google perftools CPU profiler.  This profiler is non-intrusive: it
doesn&#8217;t require recompilation, only that the application is compiled with
debugging symbols (the default).  The profiler is a sampling profiler,
which means that it periodically snapshots the program&#8217;s stack.  This is
good for finding out where your program spends its time, but will not
provide information on the number of times a function is called, or the
duration of an individual function call.  The tools are available at
<a href="http://code.google.com/p/gperftools/">http://code.google.com/p/gperftools/</a>, and may be available as an operation
system package (e.g. gperftools in Ubuntu).  Once installed, you can
enable the profiler with the CPUPROFILE and LD_PRELOAD environment
variables.  E.g. if using Mpich, which automatically passes environment
variables to MPI processes, the following is sufficient:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>export LD_PRELOAD=/usr/lib/libprofiler.so
export CPUPROFILE=./turbine.prof
turbine -n8 program.tcl</code></pre>
</div></div>
<div class="paragraph"><p>This will output profiling information files with the ./turbine.prof prefix
and the process ID appended.  Once you have the profiles, you can view the
information in various formats, including text and graphical.</p></div>
<div class="literalblock">
<div class="content">
<pre><code>pprof --text `which tclsh8.5` turbine.prof_12345 &gt; turbine.prof_12345.txt
pprof --pdf `which tclsh8.5` turbine.prof_12345 &gt; turbine.prof_12345.pdf</code></pre>
</div></div>
<div class="paragraph"><p>Note: on Ubuntu, <code>pprof</code> is renamed to <code>google-pprof</code>.</p></div>
<div class="sect2">
<h3 id="_file_index">10.1. File index</h3>
<div class="paragraph"><p><em>Most important files first.</em></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>adlb.h</code>
</dt>
<dd>
<p>
The ADLB API
</p>
</dd>
<dt class="hdlist1">
<code>adlb-defs.h</code>
</dt>
<dd>
<p>
Key definitions, error codes, and parameters
</p>
</dd>
<dt class="hdlist1">
<code>adlb.c</code>
</dt>
<dd>
<p>
The ADLB client-side implementation (communicates with servers)
</p>
</dd>
<dt class="hdlist1">
<code>handlers.[ch]</code>
</dt>
<dd>
<p>
Server-side handling and function dispatch for client RPCs
</p>
</dd>
<dt class="hdlist1">
<code>adlb_types.[ch]</code>
</dt>
<dd>
<p>
ADLB data type definitions and serialization code
</p>
</dd>
<dt class="hdlist1">
<code>checks.h</code>
</dt>
<dd>
<p>
ADLB functions can produce a nice error stack with these functions.
</p>
</dd>
<dt class="hdlist1">
<code>common.[ch]</code>
</dt>
<dd>
<p>
Some common functions and global state.
</p>
</dd>
<dt class="hdlist1">
<code>data.[ch]</code>
</dt>
<dd>
<p>
The ADLB data module (<code>_Store()</code>, <code>_Retrieve()</code>)
</p>
</dd>
<dt class="hdlist1">
<code>engine.[ch]</code>
</dt>
<dd>
<p>
Implementation for data-dependent execution
</p>
</dd>
<dt class="hdlist1">
<code>workqueue.[ch]</code>
</dt>
<dd>
<p>
Storage for work units that are ready to run
</p>
</dd>
<dt class="hdlist1">
<code>requestqueue.[ch]</code>
</dt>
<dd>
<p>
Storage for workers waiting for work
</p>
</dd>
<dt class="hdlist1">
<code>debug.[ch]</code>
</dt>
<dd>
<p>
Debugging macros
</p>
</dd>
<dt class="hdlist1">
<code>debug_symbols.[ch]</code>
</dt>
<dd>
<p>
Features for Swift-level debug symbols, not
fully implemented
</p>
</dd>
<dt class="hdlist1">
<code>messaging.[ch]</code>
</dt>
<dd>
<p>
MPI tag definitions; also human-readable names for debugging
</p>
</dd>
<dt class="hdlist1">
<code>server.[ch]</code>
</dt>
<dd>
<p>
The main ADLB server loop
</p>
</dd>
<dt class="hdlist1">
<code>steal.[ch]</code>
</dt>
<dd>
<p>
Server-server work steals
</p>
</dd>
<dt class="hdlist1">
<code>sync.[ch]</code>
</dt>
<dd>
<p>
Server-server synchronization, largely for steals
</p>
</dd>
<dt class="hdlist1">
<code>backoffs.[ch]</code>
</dt>
<dd>
<p>
ADLB uses timed backoffs when doing certain
operations, these are configured here.
</p>
</dd>
<dt class="hdlist1">
<code>notifications.[ch]</code>
</dt>
<dd>
<p>
Data structures and functions for sending notifications about data
dependency resolution
</p>
</dd>
<dt class="hdlist1">
<code>location.[ch]</code>
</dt>
<dd>
<p>
Location functionality
</p>
</dd>
<dt class="hdlist1">
<code>layout.[ch]</code>, <code>layout-defs.h</code>
</dt>
<dd>
<p>
Rank and hostname functions, mapping from workers to servers
</p>
</dd>
<dt class="hdlist1">
<code>data_structs.[ch]</code>
</dt>
<dd>
<p>
Support for the ADLB struct type
</p>
</dd>
<dt class="hdlist1">
<code>refcount.[ch]</code>
</dt>
<dd>
<p>
Reference counting for ADLB data
</p>
</dd>
<dt class="hdlist1">
<code>multiset.[ch]</code>
</dt>
<dd>
<p>
An abstract data structure for use in certain data storage cases
</p>
</dd>
<dt class="hdlist1">
<code>mpi-tools.[ch]</code>
</dt>
<dd>
<p>
A MPI error check
</p>
</dd>
<dt class="hdlist1">
<code>data_cleanup.[ch]</code>
</dt>
<dd>
<p>
ADLB garbage collection
</p>
</dd>
<dt class="hdlist1">
<code>data_internal.h</code>
</dt>
<dd>
<p>
Some internal data module definitions and error
handling macros
</p>
</dd>
<dt class="hdlist1">
<code>adlb-xpt.[ch]</code>, <code>xpt_index.[ch]</code>, <code>xpt_file.c</code>
</dt>
<dd>
<p>
Features for checkpointing, minimally tested
</p>
</dd>
<dt class="hdlist1">
<code>adlb-version.h.in</code>
</dt>
<dd>
<p>
Version numbers (manipulated by the build system)
</p>
</dd>
<dt class="hdlist1">
<code>client_internal.h</code>
</dt>
<dd>
<p>
A couple prototypes (should be moved?)
</p>
</dd>
<dt class="hdlist1">
<code>adlb_conf.h</code>
</dt>
<dd>
<p>
Autotools-generated header
</p>
</dd>
<dt class="hdlist1">
<code>adlb_prof.c</code>
</dt>
<dd>
<p>
Profiling interface, like the <code>PMPI_</code> interfaces in MPI.
</p>
</dd>
<dt class="hdlist1">
<code>mpe-settings.h</code>
</dt>
<dd>
<p>
MPE configuration (filtered by <code>configure</code>)
</p>
</dd>
<dt class="hdlist1">
<code>adlb-mpe.h</code>
</dt>
<dd>
<p>
ADLB MPE configuration switch
</p>
</dd>
<dt class="hdlist1">
<code>mpe-tools.[ch]</code>
</dt>
<dd>
<p>
MPE functionality
</p>
</dd>
</dl></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_suites">11. Test suites</h2>
<div class="sectionbody">
<div class="paragraph"><p>Each component has a testing mechanism:</p></div>
<div class="sect2">
<h3 id="_makefile_based_tests">11.1. Makefile-based tests</h3>
<div class="paragraph"><p>For the three Makefile-based modules, the test conventions are:</p></div>
<div class="ulist"><ul>
<li>
<p>
You can compile the tests with <code>make tests</code>
</p>
</li>
<li>
<p>
You can run the tests with <code>make test_results</code>
</p>
</li>
<li>
<p>
When test <code>X</code> runs, its output is directed to <code>X.tmp</code>
</p>
</li>
<li>
<p>
Each test <code>X</code> has a wrapper script <code>X.sh</code> that actually invokes the
  test
</p>
</li>
<li>
<p>
The test output may be checked by <code>X.sh</code>
</p>
</li>
<li>
<p>
If the exit code is 0, the Makefile moves <code>X.tmp</code> to <code>X.result</code>
</p>
</li>
<li>
<p>
To run a single test, do <code>make X.result</code>
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_c_utils">11.1.1. C-Utils</h4>
<div class="paragraph"><p>Just do <code>make test_results</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_adlb">11.1.2. ADLB</h4>
<div class="paragraph"><p>ADLB is primarily tested in the Turbine test suite, but you can do
<code>make test_results</code> here too.  See also <code>make apps/batcher.x</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_turbine_2">11.1.3. Turbine</h4>
<div class="paragraph"><p>Just do <code>make test_results</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_stc_2">11.2. STC</h3>
<div class="paragraph"><p>The test suite compiles a variety of SwiftScript cases and runs them
under Turbine.  See <code>stc/tests/About.txt</code> for usage, or just run
<code>tests/run-tests.zsh</code>.</p></div>
<div class="paragraph"><p>STC also has a JUnit test suite managed by <code>build.xml</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_automated_testing_jenkins">11.3. Automated testing: Jenkins</h3>
<div class="paragraph"><p>Swift/T is tested nightly on an ANL/MCS-internal Jenkins server.  It
is difficult to grant access to this system to external persons.  It
builds Swift/T and runs the Turbine and STC test suites, and also the
<a href="leaf.html">Swift/T leaf function examples</a>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_conventions_2">12. Code conventions</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Eclipse is highly recommended.
</p>
</li>
<li>
<p>
There should be no whitespace at end-of-line.  If you are fixing
  whitespace, put that fix in its own commit.
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_c_code">12.1. C code</h3>
<div class="ulist"><ul>
<li>
<p>
Open brace after newline
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_adlb_2">12.1.1. ADLB</h4>
<div class="paragraph"><p>User-visible symbols are prefixed with <code>ADLB_</code> and follow the MPI/ADLB
capitalization conventions.</p></div>
<div class="paragraph"><p>Internal symbols are prefixed with <code>xlb_</code> and use all lower case except
for macros/constants.</p></div>
</div>
<div class="sect3">
<h4 id="_turbine_3">12.1.2. Turbine</h4>
<div class="paragraph"><p>User-visible symbols are prefixed with <code>turbine_</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_java_code">12.2. Java code</h3>
<div class="paragraph"><p>Open brace before newline.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git">13. Git</h2>
<div class="sectionbody">
<div class="paragraph"><p>Everything, including this document, is at:</p></div>
<div class="paragraph"><p><a href="https://github.com/swift-lang/swift-t">https://github.com/swift-lang/swift-t</a></p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone git@github.com:swift-lang/swift-t.git</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_release_procedure">14. Release procedure</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_source_release">14.1. Source release</h3>
<div class="sect3">
<h4 id="_procedure">14.1.1. Procedure</h4>
<div class="paragraph"><p>The Swift/T maintainer does this for each Swift/T release.</p></div>
<div class="ulist"><ul>
<li>
<p>
For each component:
</p>
<div class="ulist"><ul>
<li>
<p>
Test branch <code>master</code>
</p>
</li>
<li>
<p>
Run <code>autoscan</code>
</p>
</li>
<li>
<p>
Update version numbers and dependencies
</p>
<div class="ulist"><ul>
<li>
<p>
c-utils:
</p>
<div class="ulist"><ul>
<li>
<p>
Increment <code>version.txt</code>
</p>
</li>
</ul></div>
</li>
<li>
<p>
ADLB/X:
</p>
<div class="ulist"><ul>
<li>
<p>
Increment <code>version.txt</code>
</p>
</li>
<li>
<p>
Edit <code>adlb-version.h.in</code>: update required c-utils version
</p>
</li>
</ul></div>
</li>
<li>
<p>
Turbine:
</p>
<div class="ulist"><ul>
<li>
<p>
Increment <code>version.txt</code>
</p>
</li>
<li>
<p>
Edit <code>turbine-version.h.in</code>: update required c-utils, ADLB versions
</p>
</li>
</ul></div>
</li>
<li>
<p>
STC:
</p>
<div class="ulist"><ul>
<li>
<p>
Increment <code>etc/version.txt</code>
</p>
</li>
<li>
<p>
Edit <code>turbine-version.txt</code>: update required Turbine version
</p>
</li>
<li>
<p>
Edit <code>guide.txt</code>: update version number for download and date
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Apply <code>git tag release-x.y.z</code>
</p>
</li>
<li>
<p>
Build release packages
</p>
<div class="ulist"><ul>
<li>
<p>
Edit <code>dev/get-versions.sh</code> to set the Swift/T version
</p>
</li>
<li>
<p>
Use <code>dev/release/make-release-pkg.zsh</code> to make the release package
</p>
</li>
<li>
<p>
Use <code>dev/debian/make-debs.zsh -b</code> to make the Debian package installer
</p>
</li>
<li>
<p>
Use <code>dev/build-spacks.sh</code> to make the Spack releases
</p>
</li>
<li>
<p>
Update the Spack <code>package.py</code> files and issue a pull request to Spack
</p>
</li>
</ul></div>
</li>
<li>
<p>
Copy the package to the <code>swift-t-downloads</code> repo, <code>gh-pages</code> branch
</p>
</li>
<li>
<p>
Test package on Linux and Mac
</p>
</li>
<li>
<p>
<code>git push</code> tag and downloads to GitHub
</p>
</li>
<li>
<p>
Update installation instructions in guide.txt with version numbers
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_release_tester">14.1.2. Release tester</h4>
<div class="paragraph"><p>If these instructions do not work exactly as written, that is a bug.</p></div>
</div>
<div class="sect3">
<h4 id="_anaconda_package">14.1.3. Anaconda package</h4>
<div class="paragraph"><p>See:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git@github.com:j-woz/lightsource2-recipes.git</code></pre>
</div></div>
<div class="sect4">
<h5 id="_tgz_installations">TGZ installations</h5>
<div class="paragraph"><p>The release tester just has to do:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ wget http://swift-lang.github.io/swift-t-downloads/1.4/swift-t-1.4.3.tar.gz
$ tar xfz swift-t-1.4.3.tar.gz
$ swift-t-1.4.3/dev/build/init-settings.sh
$ swift-t-1.4.3/dev/build/build-swift-t.sh
$ /tmp/swift-t-install/stc/bin/swift-t -E 'trace(42);'
trace: 42</code></pre>
</div></div>
</div>
<div class="sect4">
<h5 id="_spack_installations">Spack installations</h5>
<div class="paragraph"><p>Spack should not have to install software that you already have on
your system.
If you do not have a <code>packages.yaml</code> that covers everything except the 4
Swift/T modules, contact Wozniak for tips.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Clone:
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ git clone git@github.com:spack/spack.git spack-test
$ cd spack-test</code></pre>
</div></div>
</li>
<li>
<p>
If testing before the Spack PR is complete (typical case):
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ git remote add swift git@github.com:swift-lang/spack.git
$ git pull swift swift-release-1.4.3 # or whatever branch
$ git checkout   swift-release-1.4.3 # or whatever branch</code></pre>
</div></div>
</li>
<li>
<p>
Set up the new Spack
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ PATH=$PWD/bin:$PATH
$ . share/spack/setup-env.sh</code></pre>
</div></div>
</li>
<li>
<p>
Install from Spack
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ spack install stc@develop # From GitHub
# and/or
$ spack install stc # From the static Swift/T Downloads</code></pre>
</div></div>
<div class="paragraph"><p>Please check that the correct dependencies were installed via <code>spack find</code> .<br />
Installing <code>@develop</code> should install all Swift/T modules from <code>@develop</code> .<br />
Installing a static release should install Swift/T modules from the
static downloads.</p></div>
</li>
<li>
<p>
Test execution
</p>
<div class="listingblock">
<div class="content">
<pre><code>$ spack load stc
$ swift-t -E 'trace(42);'
trace: 42</code></pre>
</div></div>
</li>
</ol></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2023-03-29 11:13:38 CEST
</div>
</div>
</body>
</html>
