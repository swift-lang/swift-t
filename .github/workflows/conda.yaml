name: Conda Build üêç

# Build the Swift/T Anaconda package

env:
  # For Chicago time on log messages:
  TZ: CST6CDT

on:
  # Schedule and workflow_dispatch (manual) only work on default branch
  schedule:
    - cron: "0 6 * * *"   # Fire at 06:00 AM every day
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - master
      # - github_action_mac
  release:
    types:
      - published

permissions:
  contents: read    # To read the project source code (git)

jobs:
  build_conda_pkg:
    name: OS=${{ matrix.os }} PY=${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          # - macos-13
          # - macos-14  # This is ARM64
          # - macos-14-arm64

        # Comma separated list of python versions to test
        python-version: ["3.11"] # "3.9",

        mpi:
          - mpich

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          dev/github-actions/check setup-conda.sh ${{ matrix.os }}

      - name: Save tool.log
        uses: actions/upload-artifact@v4
        with:
          name: tool-log
          path: tool.log

      - name: Check tool.log
        run: |
          grep "setup-conda: SUCCESS" tool.log

      - name: Build Anaconda package
        run: |
          dev/github-actions/check dev/jenkins/anaconda.sh

      - name: Save anaconda.log
        uses: actions/upload-artifact@v4
        with:
          name: anaconda-log
          path: anaconda.log

      - name: Check anaconda.log
        run: |
          # Returns error code if not found, stopping GitHub workflow
          grep "anaconda.sh: SUCCESS" anaconda.log

      - name: Report Swift/T version info
        run:  /tmp/swift-t-install/stc/bin/swift-t -v

      - name: Check that Swift/T runs
        run:  /tmp/swift-t-install/stc/bin/swift-t -E 'trace(42);'
